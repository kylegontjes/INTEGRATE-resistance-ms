---
title: "harmonize_metadata"
author: "Kyle Gontjes"
date: "`r Sys.Date()`"
output: html_document
---

 
```{r setup, include=FALSE}
require(knitr)
opts_knit$set(echo = F,warning = FALSE, message = FALSE,error=F,comment=NA) 
opts_chunk$set(echo = F,warning = FALSE, message = FALSE,error=F,comment=NA)
opts_knit$set(root.dir='~/Desktop/gl_nfs/')
```

```{r environment, echo=F, message=FALSE, include=F, results=F}
# Environment

#Packages
packages <- c("tidyverse") 

#Load Packages
invisible(lapply(packages,library,character.only=T,quietly=T))

# Print environment
set.seed(45) 
Sys.info()
sessionInfo()

# Functions
source("~/Desktop/gl_nfs/Project_Penn_KPC/Analysis/Combination_resistance/pre-intro-blbli-resistance-ms/scripts/dataset_curation/metadata_curation_functions.R")
```

```{r}
## Old
df_201415 <- readRDS("~/Desktop/gl_nfs/Project_INTEGRATE/Analysis/Resistance_dynamics/INTEGRATE-resistance-ms/data/dataset/Penn_KPC_metadata_qcd_merged.RDS") %>% as.data.frame() %>% subset(qc_pass==T  & CRE==T)

## New
df_202123 <-  readRDS("~/Desktop/gl_nfs/Project_INTEGRATE/Analysis/Resistance_dynamics/INTEGRATE-resistance-ms/data/dataset/INTEGRATE_metadata_qcd_merged.RDS") %>% as.data.frame()%>% subset(qc_pass==T & CRE==T)
```

# Source
```{r}
# Old
table(df_201415$source)
df_201415$source_site <- df_201415$source
df_201415$source_simplified <- recode(df_201415$source,"blood"='blood','resp'='respiratory','urine'='urine','wound'='wound','Wound'='wound')

# INTEGRATE
table(df_202123$source_site)

df_202123$source_simplified <- ifelse(df_202123$source_site %in% c("Wound","Wound Right Posterior Dorsal Hand","Sacrum","Buttock"),"wound",ifelse(df_202123$source_site %in% c("Bronchial","Bronchial Wash","Bronchial Washing","Bronchoalveolar Lavage","Trachael Aspirate","Tracheal Aspirate","Sputum","Pleural Fluid"),"respiratory",ifelse(df_202123$source_site %in% c("Urine","Urine Catheterized"),"urine",ifelse(df_202123$source_site %in% c("Rectal","Recal"),"rectal",ifelse(df_202123$source_site %in% c("Blood"),"blood",ifelse(is.na(df_202123$source_site),NA,"other"))))))
```

# Date
```{r}
# Old
df_201415$date <- lubridate::date(df_201415$Cx_date)
df_201415$year <- lubridate::year(df_201415$Cx_date)
df_201415$year_quarter <- paste0(df_201415$year,"_",lubridate::quarter(df_201415$date),"Q")

# INTEGRATE
df_202123$date <- lubridate::date(df_202123$collect_date)
df_202123$year <- lubridate::year(df_202123$collect_date)
df_202123$year_quarter <- paste0(df_201415$year,"_",lubridate::quarter(df_202123$date),"Q")
```

# Location
```{r}
# Old
df_201415$hospital_location <- df_201415$LTACH2 %>% gsub(" CA","",.)
```

# Culture date data
```{r}
#  Old
df_201415$los_before_culture <-  as.numeric(df_201415$LOSbeforeCx)
df_201415$los_after_culture <-  as.numeric(df_201415$LOS_after_cx)

# INTEGRATE
df_202123$los_before_culture <- as.numeric(df_202123$collect_date - df_202123$admit_date)
df_202123$los_after_culture <- as.numeric(df_202123$discharge_date - df_202123$collect_date)
```
  
# Standardize metadata
## Sex, age, race data
```{r}
# Age, sex, race, ethnicitiy 
df_202123$participant_sex <- recode(df_202123$patient_sex,'F'='female',
                                    'M'='male')
df_201415$participant_sex <- df_201415$sex

# Age
df_202123$participant_age_at_first_enc <-   df_202123$age_at_first_enc
df_201415$participant_age_at_first_enc <- round(df_201415$age,digits = 0)

# Race
df_202123$participant_race <- df_202123$patient_race
df_201415$participant_race <- rep(NA,nrow(df_201415))

# Ethnicity
df_202123$participant_ethnicity <- df_202123$patient_ethnicity
df_201415$participant_ethnicity <- rep(NA,nrow(df_201415))
```

# Merge datasets 

```{r} 
MIC_variables <- c('MERO',"IMI",'MVB','IR','PLZ','CST','OMC','DLX','ERV','CZA',"FDC","CT","FOS")
resistance_variables <- sort(c(MIC_variables,paste0(MIC_variables,"_num"),paste0(MIC_variables,"_log_2"),paste0(MIC_variables,"_cat"),paste0(MIC_variables,"_dich_num"),"blbli_dich_num"))
shared_new_variables_w_old_not_res <- colnames(df_202123)[colnames(df_202123) %in% colnames(df_201415)] %>% subset(!. %in% resistance_variables) 

variables_of_interest <- unique(c("sample_id","isolate_no",shared_new_variables_w_old_not_res,resistance_variables))

df_202123_shared <- df_202123 %>% select(any_of(variables_of_interest))
df_201415_shared <- df_201415  %>% select(any_of(variables_of_interest))
```

# Metadata detining before merging
```{r}
# Numeric
cols_to_make_numeric <- c("total_reads", "total_bp", "mean_read_length","coverage","after_trim_gc","after_trim_total_bases","after_trim_total_sequences","after_trim_median_sequence_length","after_trim_avg_sequence_length","after_trim_total_deduplicated_percentage","n_50","total_length","total_of_contigs","ani","align_fraction_ref","align_fraction_query")

df_201415_shared <- df_201415_shared %>%
  mutate(across(all_of(cols_to_make_numeric), as.numeric))

df_202123_shared <- df_202123_shared %>%
  mutate(across(all_of(cols_to_make_numeric), as.numeric)) 

# Logical
cols_to_make_logical <- c("qc_pass","CRE")

df_201415_shared <- df_201415_shared %>%
  mutate(across(all_of(cols_to_make_logical), as.logical))

df_202123_shared <- df_202123_shared %>%
  mutate(across(all_of(cols_to_make_logical), as.logical)) 
```

# Merging
```{r}  
df_metadata_all <- bind_rows(df_201415_shared,df_202123_shared)

# New data variables
df_metadata_all$Species_ST <- paste0(df_metadata_all$species," ",df_metadata_all$ST)
df_metadata_all$study <- ifelse(grepl("PCMP_H",df_metadata_all$isolate_no),"2014-15","2021-23") %>% factor(.,levels = c("2014-15","2021-23"))
df_metadata_all$genus <- str_split(df_metadata_all$species," ",simplify = T) %>% .[,1] 
df_metadata_all$rectal <-  ifelse(df_metadata_all$source_simplified == "rectal","Rectal","Clinical")
df_metadata_all$rectal_logical <- ifelse(df_metadata_all$source_simplified == "rectal",T,F)
df_metadata_all$extraintestinal_logical <- !df_metadata_all$rectal_logical  
recode_LTACH_string <- sort(df_metadata_all$hospital_location) %>% unique %>% `names<-`(paste0("LTACH ",1:length(.))) %>% setNames(names(.), .)

df_metadata_all$hospital_location_recode <- dplyr::recode(df_metadata_all$hospital_location, !!! recode_LTACH_string)   %>% factor(.,levels = paste0("LTACH ", 1:length(recode_LTACH_string)) )

rownames(df_metadata_all) <- df_metadata_all$isolate_no

paste0("Number of final rows: ", nrow(df_metadata_all))
paste0("Number of final columns: ", ncol(df_metadata_all))
paste0("Columns in dataset: ")
colnames(df_metadata_all)
```

# Save dataset
```{r}
saveRDS(df_metadata_all,"~/Desktop/gl_nfs/Project_INTEGRATE/Analysis/Resistance_dynamics/INTEGRATE-resistance-ms/data/dataset/CA_LTACH_CRE_genomes_merged_studies_metadata.RDS")
```
