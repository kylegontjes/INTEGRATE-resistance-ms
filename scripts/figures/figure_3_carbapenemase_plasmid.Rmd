---
title: "Figure 3: Carbapenemase plasmids"
author: "Kyle Gontjes"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}
require(knitr)
opts_knit$set(echo = T,warning = FALSE, message = FALSE,error=F,comment=NA) 
opts_chunk$set(echo = T,warning = FALSE, message = FALSE,error=F,comment=NA)
opts_knit$set(root.dir='~/Desktop/gl_nfs/Project_INTEGRATE/Analysis/Resistance_dynamics/INTEGRATE-resistance-ms')
```

# Environment

```{r}
# Packages
packages <- c("tidyverse","gridExtra","kableExtra","tableone","gontjesr","cowplot","ComplexHeatmap",'ggalluvial')
lapply(packages,library,character.only=T)

# Functions
source("./lib/consistent_themes.R")

# Print environment
Sys.info()
sessionInfo()
```

# Load data

```{r}
df <- readRDS("./data/dataset/CA_LTACH_first_clinical_per_quarter_CRKP_genomes_merged_studies_metadata.RDS")   
```

# Coordinate ST data

```{r} 
break_of_sts <-  c(sort(unique(df$Species_ST_recode %>% subset(.!="Singleton STs"))),"Singleton STs")
break_of_sts_renamed <- gsub("Klebsiella pneumoniae ","",break_of_sts)
       
ST_scale <- scale_fill_manual(breaks = break_of_sts,values = c(hues::iwanthue(n = length(unique(df$Species_ST_recode)) -1),"lightgray"),labels = break_of_sts_renamed,name = "Sequence type", guide = guide_legend(ncol=7, title.position = "top", label.position = "right"))

df$Species_ST_recode_no_species <- gsub("Klebsiella pneumoniae ","",df$Species_ST)
 
df_201415 <- df%>% subset(study == "2014-15")
df_202123<- df%>% subset(study == "2021-23")
```

# Load carbapenemase data
```{r}
carbapenemase_content <- readRDS("./data/carbapenemase_content/carbapenemase_content_merged_studies.RDS")
df <- left_join(df,carbapenemase_content)
```

# Load plasmid data
```{r}
mobtyper_merged <- readRDS("./data/mobsuite/mobtyper_merged_w_carbapenemase_data.RDS") %>% subset(isolate_no %in% df$isolate_no)
```

# A. KPC plasmids
```{r}
carbapenemase_plasmids <- c(mobtyper_merged  %>% subset(carbapenemase_plasmid ==1) %>% .$primary_cluster_id %>% unique %>% sort)
plasmid_fill <- scale_fill_manual(breaks = c(carbapenemase_plasmids,"Chromosome","No carbapenemase"),values = c(hues::iwanthue(length(carbapenemase_plasmids)),"darkgray",'lightgray'),name="Carbapenemase-containing plasmid",guide = guide_legend(title.position = "top", label.position = "right"))

mobtyper_prop <-  df   %>%
  count(study, carbapenemase_plasmid) %>%
  complete(study, carbapenemase_plasmid, fill = list(n = 0)) %>%
  group_by(study) %>%
  mutate(prop = n / sum(n) * 100) 

get_factor_order_plasmid <- function(ST_dist,var){
  new_order <- ST_dist %>% subset(study =='2021-23') %>% arrange(-n) %>% subset(n>0) %>% .[[var]] 
  zero_new_order_old <- ST_dist %>% subset(study =='2014-15') %>% subset(!get(var) %in% new_order) %>% arrange(-n) %>% .[[var]]
  c(c(new_order,zero_new_order_old) %>% subset(!.%in% c("Chromosome","No carbapenemase")),"Chromosome","No carbapenemase")
}
 
df$carbapenemase_plasmid <- factor(df$carbapenemase_plasmid,levels = get_factor_order_plasmid(mobtyper_prop,'carbapenemase_plasmid'))
mobtyper_prop$carbapenemase_plasmid <- factor(mobtyper_prop$carbapenemase_plasmid,levels = get_factor_order_plasmid(mobtyper_prop,'carbapenemase_plasmid'))

A <- ggplot(data=df ,aes(y=carbapenemase_plasmid,fill=carbapenemase_plasmid)) + geom_bar(stat='count')  + theme_bw_me + ylab("") + labs(fill="carbapenemase_plasmid") + facet_wrap(~study) + plasmid_fill  + xlab("Isolates") + theme(legend.position = 'none') +
  geom_text(stat='count',
            aes(label=..count..),
            hjust=-0.05, 
            size=3.5)  + xlim(NA,100.1) +
  theme(
    axis.text.x = element_text(hjust = 0.5, size=12, color="black"),
    axis.text.y = element_text(size=12, color="black"),
    axis.title = element_text(size = 14, color="black"),
                  legend.text =   element_text(size=12, color="black"),
                  legend.title = element_text(size = 12, color="black"),
    plot.title = element_text(size = 0, color="black"),
    legend.position = "none",
    strip.text = element_text(size=14,color='black')
  )
A
```

## C. Species ST
```{r} 
get_factor_order <- function(ST_dist,var){
  new_order <- ST_dist %>% subset(study =='2021-23') %>% arrange(-n) %>% subset(n>0) %>% .[[var]] 
  zero_new_order_old <- ST_dist %>% subset(study =='2014-15') %>% subset(!get(var) %in% new_order) %>% arrange(-n) %>% .[[var]]
  c(c(new_order,zero_new_order_old) %>% subset(.!="Singleton STs"),"Singleton STs")
}
 
ST_dist <-  df  %>%
  count(study, Species_ST_recode) %>%
  complete(study, Species_ST_recode, fill = list(n = 0)) %>%
  group_by(study) %>%
  mutate(prop = n / sum(n) * 100)
   
df$Species_ST_recode <- factor(df$Species_ST_recode,levels = get_factor_order(ST_dist,'Species_ST_recode'))

C <- ggplot(data=df,
       aes(y=Species_ST_recode, fill=carbapenemase_plasmid)) +
  geom_bar() +
  xlim(NA, 220.1) +
  theme_bw_me +
  xlab("Isolates") + ylab("") +
  theme(
    axis.text.x = element_text(hjust = 0.5, size=12, color="black"),
    axis.text.y = element_text(size=12, color="black"),
    axis.title = element_text(size = 14, color="black"),
                  legend.text =   element_text(size=12, color="black"),
                  legend.title = element_text(size = 12, color="black"),
    plot.title = element_text(size = 0, color="black"),
    legend.position = "none",
    strip.text = element_text(size=14,color='black')
        
  ) + plasmid_fill + facet_wrap(~study)

C
```

# B. Proportion of plasmids over study periods
```{r}
B <-  ggplot(mobtyper_prop  ,aes(x = study,stratum = carbapenemase_plasmid,alluvium = carbapenemase_plasmid,y=prop,fill = carbapenemase_plasmid)) +
  geom_alluvium(aes(fill = carbapenemase_plasmid),width=0.66,alpha=0.75) +
  geom_stratum(width=0.66,linewidth = 0.15) + theme_bw_me + xlab("Study") + ylab("Percentage (%)")  + theme(legend.position = "bottom",
                  axis.text =   element_text(size=12, color="black"),
                  axis.title = element_text(size = 14, color="black"),
                  legend.text =   element_text(size=8, color="black"),
                  legend.title = element_text(size = 10, color="black"),
                  plot.title = element_text(size = 12, color="black")) + scale_y_continuous(breaks = c(0,20,40,60,80,100)) +  plasmid_fill+ ggtitle("All isolates") 

B
```

# D. ST258 genomes
```{r}
ST258_genomes <- df %>% subset(ST=="ST258") %>% .$isolate_no
mobtyper_prop_ST258 <-  df %>% subset(ST=="ST258")   %>%
  count(study, carbapenemase_plasmid) %>%
  complete(study, carbapenemase_plasmid, fill = list(n = 0)) %>%
  group_by(study) %>%
  mutate(prop = n / sum(n) * 100)
 
D <-  ggplot(mobtyper_prop_ST258  ,aes(x = study,stratum = carbapenemase_plasmid,alluvium = carbapenemase_plasmid,y=prop,fill = carbapenemase_plasmid)) +
  geom_alluvium(aes(fill = carbapenemase_plasmid),width=0.66,alpha=0.75) +
  geom_stratum(width=0.66,linewidth = 0.15) + theme_bw_me + xlab("Study") + ylab("Percentage (%)")  + theme(legend.position = "bottom",
                  axis.text =   element_text(size=12, color="black"),
                  axis.title = element_text(size = 14, color="black"),
                  legend.text =   element_text(size=8, color="black"),
                  legend.title = element_text(size = 10, color="black"),
                  plot.title = element_text(size = 12, color="black")) + scale_y_continuous(breaks = c(0,20,40,60,80,100)) +  plasmid_fill + ggtitle("ST258 isolates") 
D
```  

```{r,fig.width=9,fig.height=9}  
AB <-  cowplot::plot_grid(A,B + theme(legend.position = 'none') ,ncol=2,rel_widths = c(1,.33),labels = c("A","B"),label_size=12)  
CD <-  cowplot::plot_grid(C + theme(legend.position = 'none'),D + theme(legend.position = 'none'),ncol=2,labels = c("C","D"),label_size = 12,rel_widths = c(1,.33))
figure_3 <-  cowplot::plot_grid(AB,CD,ncol=1,rel_heights = c(1,1),labels = c("",""),label_size=12)  
figure_3
```

```{r}
ggsave(filename = "./figures/figure_3_carbapenemase_plasmids.png",plot=figure_3,width = 9,height = 9,dpi=900,bg = 'white')
```
