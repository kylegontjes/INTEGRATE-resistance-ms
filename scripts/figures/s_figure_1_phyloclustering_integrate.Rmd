---
title: "Supplemental Figure 1: Phylogeographic analysis of major INTEGRATE STs in CA"
author: "Kyle Gontjes"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}
require(knitr)
opts_knit$set(echo = T,warning = FALSE, message = FALSE,error=F,comment=NA) 
opts_chunk$set(echo = T,warning = FALSE, message = FALSE,error=F,comment=NA)
opts_knit$set(root.dir='~/Desktop/gl_nfs/Project_INTEGRATE/Analysis/Resistance_dynamics/INTEGRATE-resistance-ms/')
```

# Environment

```{r environment, echo=F, message=FALSE, include=F, results=F}
#Packages
packages <- c("tidyverse",'ape','ggtree','phytools')

#Load Packages
invisible(lapply(packages,library,character.only=T,quietly=T))

# Print environment
set.seed(45) 
Sys.info()
sessionInfo()
```


# Sample assembly list
```{r}
public_dataset <- readRDS("~/Desktop/gl_nfs/Project_INTEGRATE/Analysis/Resistance_dynamics/INTEGRATE-resistance-ms/data/public_genomes/NCBI_metadata/NCBI_Pathogens_Kpn_metadata_isolates_w_spatiotemporal_data_121025.RDS")
public_dataset$assembly_name <- public_dataset$Assembly
paste0("Public genomes with isolate and spatiotemporal data: ",nrow(public_dataset))
kleborate_genome_list <- readr::read_lines("~/Desktop/gl_nfs/Project_INTEGRATE/Analysis/Resistance_dynamics/INTEGRATE-resistance-ms/data/public_genomes/kleborate/partitions/NCBI_pathogens_genome_assembly_list.txt")
kleborate_genome_name <- str_split(kleborate_genome_list,pattern = '/',simplify = T) %>% .[,15]
paste0("Public genomes tested for Kleborate: ",length(kleborate_genome_list))
kleborate <- read_delim("~/Desktop/gl_nfs/Project_INTEGRATE/Analysis/Resistance_dynamics/INTEGRATE-resistance-ms/data/public_genomes/kleborate/results/NCBI_pathogens_Kpn_kleborate.txt")
kleborate$assembly_name <- str_split(kleborate$strain,pattern = '_',simplify = T)   %>% .[,c(1,2)] %>% apply(.,1,paste0,collapse='_')
paste0("Public genomes with Kleborate Kpn species complex entry: ",nrow(kleborate))
paste0("Public genomes without Kleborate Kpn species complex entry: ",length(kleborate_genome_list) - nrow(kleborate))
public_dataset <- left_join(public_dataset,kleborate)
```

# Load QCD data
```{r}
qcd <- read_csv("~/Desktop/gl_nfs/Project_INTEGRATE/Public_datasets/2025-12-15_all_Kleb_NCBI_Pathogen/illumina/master_qc_summary_assembly.csv")
qcd$Assembly <- qcd$Sample
qcd <- qcd %>% rename('mlst_ST'= 'ST' ,
                      "pubQCD_N50"="N50")
public_dataset <- left_join(public_dataset,qcd)
public_dataset$isolate_no <- public_dataset$Assembly 
public_dataset$participant_id <- public_dataset$Assembly
```

# Load integrate data
```{r}
df <- readRDS("~/Desktop/gl_nfs/Project_INTEGRATE/Analysis/Resistance_dynamics/INTEGRATE-resistance-ms/data/dataset/CA_LTACH_first_clinical_per_quarter_CRKP_genomes_merged_studies_metadata.RDS")
df_kleborate <- readRDS("~/Desktop/gl_nfs/Project_INTEGRATE/Analysis/Resistance_dynamics/INTEGRATE-resistance-ms/data/kleborate/kleborate_kpsc_both_studies.RDS") 
df <- left_join(df,df_kleborate )
df$country <- "United States"
df$california <- TRUE
df$continent <- "Americas"
df$collection_date <- df$date
df$collection_year <- df$year
```

# Merge dataset
```{r}
voi <- c('isolate_no','participant_id','ST','collection_date','collection_year','continent','country','california')
combined_phylogeographic_df <- bind_rows(public_dataset %>% select(any_of(voi)),df %>% select(any_of(voi))) %>% as.data.frame
rownames(combined_phylogeographic_df) <- combined_phylogeographic_df$isolate_no 
combined_phylogeographic_df$collection_decade <- floor(combined_phylogeographic_df$collection_year/10)*10
combined_phylogeographic_df$collection_year_fct <- as.factor(combined_phylogeographic_df$collection_year)
combined_phylogeographic_df$type <- ifelse(grepl("PCMP_H",combined_phylogeographic_df$isolate_no),"2014-15 Study",
                                           ifelse(grepl("INT_CRE_",combined_phylogeographic_df$isolate_no),"2021-23 Study","Public genomes"))
combined_phylogeographic_df$california_bin <- ifelse(combined_phylogeographic_df$california==T,1,0)

# Factor
combined_phylogeographic_df$collection_decade <- factor(combined_phylogeographic_df$collection_decade,levels = c("1980",'1990','2000','2010','2020'))
combined_phylogeographic_df$continent <- factor(combined_phylogeographic_df$continent,levels = c("Africa","Americas","Asia","Europe","Oceania"))
combined_phylogeographic_df$california <- factor(combined_phylogeographic_df$california,levels = c(TRUE,FALSE))
combined_phylogeographic_df$type <- factor(combined_phylogeographic_df$type,levels = c("2014-15 Study","2021-23 Study","Public genomes"))

# California tips
CA_tips <- combined_phylogeographic_df %>% subset(california==T) %>% .$isolate_no
```

# Trees 
```{r}
tr_ST14 <- read.tree("./data/phylogeny/phylogeographic/ST14/phylogeographic_ST14.treefile") %>% drop.tip("INT_CRE_1243") 
tr_ST17 <- read.tree("./data/phylogeny/phylogeographic/ST17/phylogeographic_ST17.treefile") %>% drop.tip("INT_CRE_1243")  
tr_ST307 <- read.tree("./data/phylogeny/phylogeographic/ST307/phylogeographic_ST307.treefile") %>% drop.tip("INT_CRE_1243") 
tr_ST258 <- read.tree("./data/phylogeny/phylogeographic/ST258/phylogeographic_ST258.treefile") %>% drop.tip("INT_CRE_1243")  
```

# Scales
```{r}
total_colors <- 10
all_colors <- hues::iwanthue(total_colors,plot = T)

decade_scale <- scale_fill_manual(breaks = c("1980","1990","2000","2010","2020"),values = all_colors[c(1,2,4,5,8)],name = "Decade",guide = guide_legend(nrow=3,order=1),drop=FALSE) 

continent_scale <- scale_fill_manual(breaks = c("Africa","Americas","Asia","Europe","Oceania"),values = all_colors[c(3,7,6,9,10)],name = "Continent",guide = guide_legend(nrow=3,order=2),drop=FALSE)

california_scale <- scale_fill_manual(breaks = c(TRUE,FALSE),values = c("red","black"),labels = c("California","Other"),name = "Location",guide = guide_legend(nrow=3,order=3),drop=FALSE)

study_scale <- scale_fill_manual(breaks = c("2014-15 Study","2021-23 Study","Public genomes"),values = c("blue","brown",gray(0.2)),name = "California genome",guide = guide_legend(nrow=3,order=4),drop=FALSE)

study_scale_color <- scale_color_manual(breaks = c("2014-15 Study","2021-23 Study","Public genomes"),values = c("blue","brown",gray(0.2)),name = "California genome",guide = guide_legend(nrow=3,order=4),drop=FALSE)
```

# Reconstructions
```{r}
CA_asr <- readRDS("./data/public_genomes/california_reconstruction/california_phylogeographic_reconstruction_asr_objs.RDS")
CA_asr_cluster <- readRDS("./data/public_genomes/california_reconstruction/california_phylogeographic_reconstruction_clustering.RDS")
```
 
## Function
```{r}
get_phylogeny <- function(st,tr,df,pcdf,col_offset,ymax,point_size,line_width){
  p <- ggtree(tr)
  tip_x <- max(p$data$x) + (max(p$data$x) * .0125)
  tip_x_start <- (max(p$data$x) * .0125)
  df_ST <- df %>% subset(ST==st)
  CA_isolates <- df_ST %>% subset(california==T) %>% .$isolate_no
  tr_data <- as_tibble(tr) %>% left_join(.,df_ST, by = c("label" = "isolate_no"))
  painted_tree <- phyloAMR::paint_tree_with_states(parent_child_df = pcdf, tr = tr, scale_labels = c("California","Other"),legend_name = "California")  
  painted_tree_w_new_scale <- painted_tree  + ggnewscale::new_scale_color() 
  painted_tip_tree <- painted_tree_w_new_scale %<+% tr_data + geom_tippoint(aes(subset = california == T, x=tip_x,color = type),size = point_size,position='dodge') + study_scale_color
  
  tip_data <- painted_tip_tree$data %>%
    filter(label %in% CA_isolates) %>%
    group_by(y) %>%                  # group by tip
    arrange(type) %>%                # optional: sort within cluster 
    ungroup()
  
  painted_tip_tree_dashed <- painted_tip_tree + geom_segment(
    data = tip_data,  # subset data for layer
    aes(x = x+tip_x_start, y = y, yend = y,color=type),  # aesthetics from data
    xend = tip_x,                  # fixed coordinate outside aes
    linetype = "dashed",
    linewidth=line_width
  ) 
  
  p0 <-  gheatmap(painted_tip_tree_dashed, df_ST %>% select(collection_decade) %>% `colnames<-`("Decade"), color=NULL, width=0.05, colnames_position = 'top', colnames_angle = 90, colnames_offset_y = 25, hjust=0) + decade_scale + ylim(NA,ymax)
  p0.1 <- p0+ggnewscale::new_scale_fill()
  figure <- gheatmap(p0.1, df_ST %>% select(continent)  %>% `colnames<-`("Continent") ,color=NULL,width=0.05,offset=col_offset,colnames_position = 'top',colnames_angle = 90,colnames_offset_y = 25,hjust=0) + continent_scale + ylim(NA,ymax)  
  return(figure)
}
```

## ST258
```{r} 
A <- get_phylogeny(st='ST258',tr=tr_ST258,df = combined_phylogeographic_df, pcdf = CA_asr$ST258$parent_child_df, col_offset = 0.001125,ymax = 7100,point_size=0.1,line_width=0.05)
A  + theme(legend.position='none')
```

# ST307
```{r}
B <- get_phylogeny(st='ST307',tr=tr_ST307,df = combined_phylogeographic_df, pcdf = CA_asr$ST307$parent_child_df, col_offset = 0.001,ymax = 4900,point_size=0.1,line_width=0.05)
B + theme(legend.position='none')
```

## ST14
```{r}
C <- get_phylogeny(st='ST14',tr=tr_ST14,df = combined_phylogeographic_df, pcdf = CA_asr$ST14$parent_child_df, col_offset = 0.004,ymax = 1950,point_size=0.1,line_width=0.05)
C  + theme(legend.position='none')
```

## ST17
```{r} 
D <- get_phylogeny(st='ST17',tr=tr_ST17,df = combined_phylogeographic_df, pcdf = CA_asr$ST17$parent_child_df, col_offset = 0.0015,ymax = 1700,point_size=0.1,line_width=0.05)
D + theme(legend.position='none')
```

# Create plots to grab legend! 
```{r}
decade <- ggplot(data=combined_phylogeographic_df,aes(x=collection_decade,fill=collection_decade)) + geom_bar(stat='count') + decade_scale
continent <- ggplot(data=combined_phylogeographic_df,aes(x=continent,fill=continent)) + geom_bar(stat='count') + continent_scale 
study <- ggplot(data=combined_phylogeographic_df,aes(x=type,fill=type)) + geom_bar(stat='count') + study_scale
california <- ggplot(data=combined_phylogeographic_df,aes(x=california,fill=california)) + geom_bar(stat='count') + california_scale

decade_legend <- cowplot::get_legend(decade) %>% cowplot::plot_grid()
continent_legend <- cowplot::get_legend(continent) %>% cowplot::plot_grid() 
study_legend <- cowplot::get_legend(study) %>% cowplot::plot_grid()
california_legend <- cowplot::get_legend(california) %>% cowplot::plot_grid()

legends <- cowplot::plot_grid(california_legend,study_legend,decade_legend,continent_legend,ncol=4)
```
 
# Cowplot figure
```{r,fig.width=10,fig.height=15}
main <- cowplot::plot_grid(A + theme(legend.position = 'none'),B+ theme(legend.position = 'none'),C+ theme(legend.position = 'none'),D+ theme(legend.position = 'none'),ncol=2,labels = c("A. ST258","B. ST307","C. ST14","D. ST17"))
figure <- cowplot::plot_grid(main,legends,ncol=1,rel_heights = c(1,0.075))
figure
```

```{r}
ggsave(filename = "./figures/s_figure_1_phylogeographic.png",plot = figure,dpi=900,bg='white',height=15,width=10)
```

