---
title: "Supplemental Figure 1: Sampling dynamics"
author: "Kyle Gontjes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
require(knitr)
opts_knit$set(echo = T,warning = FALSE, message = FALSE,error=F,comment=NA) 
opts_chunk$set(echo = T,warning = FALSE, message = FALSE,error=F,comment=NA)
opts_knit$set(root.dir='~/Desktop/gl_nfs/')
```

# Environment
```{r}
# Packages
packages <- c("tidyverse","gridExtra","kableExtra","cowplot","forcats","ggalluvial")
lapply(packages,library,character.only=T)

# Functions
source("./Project_INTEGRATE/Analysis/Resistance_dynamics/INTEGRATE-resistance-ms/lib/consistent_themes.R")

# Print environment
Sys.info()
sessionInfo() 
```

# Load data
```{r}
df <- readRDS("~/Desktop/gl_nfs/Project_INTEGRATE/Analysis/Resistance_dynamics/2025-09-18_master_kpn_first_isolate_dataset_curation/results/CA_clinical_CRKP_first_isolate_metadata_091825.RDS")  

recode_LTACH_string <- sort(df$hospital_location) %>% unique %>% `names<-`(paste0("LTACH ",1:length(.))) %>% setNames(names(.), .)

df$hospital_location_recode <- dplyr::recode(df$hospital_location, !!! recode_LTACH_string)   %>% factor(.,levels =paste0("LTACH ",1:length(recode_LTACH_string)) )

df_201415 <- df%>% subset(study == "2014-15")
df_202123 <- df%>% subset(study == "2021-23")

df_202123_all <- readRDS("~/Desktop/gl_nfs/Project_INTEGRATE/Analysis/Resistance_dynamics/2025-09-18_master_kpn_first_isolate_dataset_curation/results/CA_clinical_CRE_metadata_091825.RDS")  %>% subset(study == '2021-23')

number_of_weeks_1415 <- as.numeric(round(difftime(max(df_201415$date,na.rm = T),min(df_201415$date,na.rm = T),units = 'weeks')) + 1)
number_of_weeks_2123 <- as.numeric(round(difftime(max(df_202123_all$date,na.rm = T),min(df_202123_all$date,na.rm = T),units = 'weeks')) + 1)
```

## A. 2021-23
```{r}      
A <- ggplot(data = df %>% subset(study == "2021-23")) +
  geom_histogram(
    aes(x = date, fill = study),  # << key addition
    bins = number_of_weeks_2123
  ) +
  xlab("Collection date") +
  ylab("Isolates") +
  theme_bw_me +
  scale_x_date(
    date_breaks = "6 months",
    date_labels = "%m-%Y"
  ) +
  study_color_fill +
  theme(
    legend.position = 'none',
    axis.text = element_text(size=10, color="black",hjust=0.5,vjust=0.5),
    axis.title = element_text(size=12, color="black"),
    legend.text = element_text(size=10, color="black"),
    legend.title = element_text(size=12, color="black"),
    plot.title = element_text(size=0, color="black")
  ) + ylim(NA,15.1)
```

## B. 2014-15
```{r}
B <- ggplot(data = df %>% subset(study == "2014-15")) +
  geom_histogram(
    aes(x = date, fill = study),  # << key addition
    bins = number_of_weeks_1415
  ) +
  xlab("Collection date") +
  ylab("Isolates") +
  theme_bw_me +
  scale_x_date(
    date_breaks = "3 months",
    date_labels = "%m-%Y"
  ) +
  study_color_fill +
  theme(
    legend.position = 'none',
    axis.text = element_text(size=10, color="black"),
    axis.title = element_text(size=12, color="black"),
    legend.text = element_text(size=10, color="black"),
    legend.title = element_text(size=12, color="black"),
    plot.title = element_text(size=0, color="black")
  ) + ylim(NA,15.1)
```

# C. Source
```{r}
df$study <- factor(df$study,levels = c("2014-15","2021-23"))
df$source_simplified <- factor(df$source_simplified,levels = c(df %>% group_by(source_simplified) %>% summarise (n=n()) %>% arrange(-n) %>% .$source_simplified))

source_scale <- scale_fill_manual(breaks = levels(df$source_simplified),values = c(hues::iwanthue(n = length(unique(df$source_simplified)))),name = "Source", guide = guide_legend(ncol=1, title.position = "top", label.position = "right")) 

source_dist <-  df %>% subset(is.na(source_simplified)==F)   %>%
  count(study, source_simplified) %>%
  complete(study, source_simplified, fill = list(n = 0)) %>%
  group_by(study) %>%
  mutate(prop = n / sum(n) * 100)
   
source_dist$source_simplified <- factor(source_dist$source_simplified,levels = source_dist %>% subset(study =='2021-23') %>% arrange(n) %>% group_by(source_simplified) %>% summarise (n = sum(n)) %>% arrange(-n) %>% .$source_simplified)

C <- ggplot(source_dist %>% subset(n>0),aes(x = study,stratum = source_simplified,alluvium = source_simplified,y=prop,fill = source_simplified)) +
  geom_alluvium(aes(fill = source_simplified)) +
  geom_stratum() + theme_bw_me + xlab("Study") + ylab("Percentage") + source_scale + theme(legend.position = "right",
                  axis.text =   element_text(size=10, color="black"),
                  axis.title = element_text(size = 12, color="black"),
                  legend.text =   element_text(size=10, color="black"),
                  legend.title = element_text(size = 12, color="black"),
                  plot.title = element_text(size = 0, color="black")) 
```
 
# D. Sample counts by facility
```{r}
df_complete <- df %>%
  count(hospital_location_recode, study) %>%
  complete(hospital_location_recode, study)  

df_complete$prop <- ifelse(df_complete$study=='2021-23',df_complete$n / sum(df_complete %>% subset(study == '2021-23') %>% .$n,na.rm=T),df_complete$n / sum(df_complete %>% subset(study == '2014-15') %>% .$n,na.rm=T))
df_complete$perc <- df_complete$prop *100 

# Group df_complete by study and have proportion be n per hospital location
df_complete <- df_complete %>% group_by(study,hospital_location_recode)  

df_complete$hospital_location_recode <- factor(
  df_complete$hospital_location_recode,
  levels = df_complete %>% subset(study == "2021-23") %>% 
    group_by(hospital_location_recode) %>%
    summarise(n = sum(n, na.rm = TRUE)) %>%
    arrange(-n) %>%
    pull(hospital_location_recode)
)

df_complete$study <- factor(df_complete$study ,levels = c("2021-23","2014-15"))

D <- ggplot(data = df_complete) +
  geom_bar(
    aes(x = n, y = hospital_location_recode, fill = study),
    stat = "identity",
    position = position_dodge(width = 0.9)
  ) +
  geom_text(
    aes(x = n, y = hospital_location_recode, label = n, group = study),
    position = position_dodge(width = 0.9),
    hjust = -0.2,
    size = 2.5
  ) +
  xlab("Isolates") +
  ylab("") +
  xlim(NA, 72) +
  theme_bw_me +
  labs(fill = "Study") +
  study_color_fill +
  theme(legend.position='bottom',
    axis.text = element_text(size = 10, color = "black",hjust=0.5,vjust=0.5),
    axis.title = element_text(size = 12, color = "black"), 
    legend.text = element_text(size = 10, color = "black"),
    legend.title = element_text(size = 12, color = "black"),
    plot.title = element_text(size = 0, color = "black")
  )  
```

## E. Proportion by study
```{r}
E <- ggplot(data = df_complete) +
  geom_bar(
    aes(x = perc, y = hospital_location_recode, fill = study),
    stat = "identity",
    position = position_dodge(width = 0.9)
  ) +
  geom_text(
    aes(x = perc, y = hospital_location_recode, label = round(perc,2), group = study),
    position = position_dodge(width = 0.9),
    hjust = -0.2,
    size = 2.5
  ) +
  xlab("Percentage") +
  ylab("") +
  xlim(NA, 20.01) +
  theme_bw_me +
  labs(fill = "Study") +
  study_color_fill +
  theme(legend.position='bottom',
    axis.text = element_text(size = 10, color = "black",hjust=0.5,vjust=0.5),
    axis.title = element_text(size = 12, color = "black"), 
    legend.text = element_text(size = 10, color = "black"),
    legend.title = element_text(size = 12, color = "black"),
    plot.title = element_text(size = 0, color = "black")
  )

```

```{r,fig.width=8,fig.height=8} 
AB <- cowplot::plot_grid(A,B + theme(legend.position = 'none'),ncol=2,labels =c("A","B"),rel_widths = c(1,1))

legend <- gontjesr::get_legend(D+ theme(legend.position='bottom'))
Cowplot_legend <- plot_grid(legend,ncol=1)
C <- cowplot::plot_grid(C,legend,ncol=2,labels = c("C",""))
DE <-  cowplot::plot_grid(D+ theme(legend.position = 'none'),E + theme(legend.position = 'none'),ncol=2,labels =c("D","E"),rel_widths = c(1,1))

sfigure1 <- cowplot::plot_grid(AB,C,DE,ncol=1,rel_heights = c(0.65,0.65,1))
sfigure1 
``` 

```{r}
ggsave(filename = "./Project_INTEGRATE/Analysis/Resistance_dynamics/INTEGRATE-resistance-ms/figures/s_figure_1_sampling.png",plot=sfigure1,width = 8,height = 8,dpi=900,bg = 'white')
```

