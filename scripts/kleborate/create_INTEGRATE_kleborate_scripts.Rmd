---
title: "create_INTEGRATE_kleborate_sciprt"
author: "Kyle Gontjes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
require(knitr)
opts_knit$set(echo = F,warning = FALSE, message = FALSE,error=F,comment=NA) 
opts_chunk$set(echo = F,warning = FALSE, message = FALSE,error=F,comment=NA)
opts_knit$set(root.dir='~/Desktop/gl_nfs/Project_INTEGRATE/Analysis/Resistance_dynamics/INTEGRATE-resistance-ms/')
```


# Environment

```{r environment, echo=F, message=FALSE, include=F, results=F}
#Packages
packages <- c("tidyverse") 

#Load Packages
invisible(lapply(packages,library,character.only=T,quietly=T))

# Print environment
set.seed(45) 
Sys.info()
sessionInfo()
```

# Sequencing data
```{r}  
# QCD
qcd <- read.csv("../../../Sequence_data/illumina_fastq/master_qc_summary.csv")  %>% subset(grepl("NEG_CTL",Sample)==F) 
qcd$qc_pass <- qcd$QC.Check=="PASS"  
qcd_pass <- subset(qcd,qc_pass==T)
``` 

# Species 
```{r}
table(qcd_pass$Species)
```

# Kpn genomes - https://www.nature.com/articles/s41579-019-0315-1
```{r}
kpn_genomes <- qcd_pass %>% subset(Species %in% c("Klebsiella pneumoniae","Klebsiella quasipneumoniae","Klebsiella variicola", "Klebsiella africana","Klebsiella quasivariicola")) %>% .$Sample %>% paste0("/nfs/turbo/umms-esnitkin/Project_INTEGRATE/Sequence_data/assembly/illumina/spades/",.,"/",.,"_contigs_l1000.fasta")
writeLines(kpn_genomes,"./scripts/kleborate/INTEGRATE_kpsc_genomes.txt") 
```

# KOSC - https://doi.org/10.1128/CMR.00006-21
```{r}
kosc_genomes <- qcd_pass %>% subset(Species %in% c("Klebsiella grimontii", "Klebsiella huaxiensis", "Klebsiella michiganensis", "Klebsiella oxytoca", "Klebsiella pasteurii", "Klebsiella spallanzanii")) %>% .$Sample %>% paste0("/nfs/turbo/umms-esnitkin/Project_INTEGRATE/Sequence_data/assembly/illumina/spades/",.,"/",.,"_contigs_l1000.fasta")
writeLines(kosc_genomes,"./scripts/kleborate/INTEGRATE_kosc_genomes.txt")
```

# Other kleb
```{r}
other_kleb_genomes <- qcd_pass %>% subset(Species %in% c("Klebsiella aerogenes")) %>% .$Sample%>% paste0("/nfs/turbo/umms-esnitkin/Project_INTEGRATE/Sequence_data/assembly/illumina/spades/",.,"/",.,"_contigs_l1000.fasta")
writeLines(other_kleb_genomes,"./scripts/kleborate/INTEGRATE_other_kleb_genomes.txt")
```

# E coli
```{r}
ecoli_genomes <- qcd_pass %>% subset(Species == "Escherichia coli") %>% .$Sample %>%  paste0("/nfs/turbo/umms-esnitkin/Project_INTEGRATE/Sequence_data/assembly/illumina/spades/",.,"/",.,"_contigs_l1000.fasta")
writeLines(ecoli_genomes,"./scripts/kleborate/INTEGRATE_ecoli_genomes.txt")
```

# Kleborate script

```{bash}
cd scripts/kleborate
echo '#!/bin/sh
# Job name
#SBATCH --job-name=kleborate_INTEGRATE_species
# User info
#SBATCH --mail-user=kgontjes@umich.edu
#SBATCH --mail-type=BEGIN,END
#SBATCH --export=ALL
#SBATCH --partition=standard
#SBATCH --account=esnitkin1
#SBATCH --output=/nfs/turbo/umms-esnitkin/Project_INTEGRATE/Analysis/Resistance_dynamics/INTEGRATE-resistance-ms/slurm_out/kleborate/kleborate_INTEGRATE_species.out
#SBATCH --nodes=1  --ntasks=1 --cpus-per-task=30 --mem=150g --time=10:00:00

IFS=$'\''\n'\'' # make newlines the only separator
set -f # disable globbing

cd /nfs/turbo/umms-esnitkin/Project_INTEGRATE/Analysis/Resistance_dynamics/INTEGRATE-resistance-ms/data/kleborate

# Version
kleborate --version

isolates=`cat /nfs/turbo/umms-esnitkin/Project_INTEGRATE/Analysis/Resistance_dynamics/INTEGRATE-resistance-ms/scripts/kleborate/INTEGRATE_species_genomes.txt` 
IFS=$'\''\n'\'' read -r -d "''" -a assembly_array <<< "$isolates"

kleborate -a "${assembly_array[@]}" -p species_complex -o species_abbrev_name_INTEGRATE --trim_headers 
' > model_INTEGRATE_kleborate.sbat
```

# Edit these
```{r}
setwd("./scripts/kleborate")
species_groups <- c("kpsc","kosc","other_kleb","ecoli")
for (species in species_groups){
  script <- readLines(paste0("model_INTEGRATE_kleborate.sbat"))
  species_complex <- recode(species,
                         "kpsc"="kpsc",
                         "kosc"="kosc",
                         "other_kleb"="kpsc",
                         "ecoli"="escherichia")
  
  species_abbrev_name  <- recode(species,
                         "kpsc"="kpsc",
                         "kosc"="kosc",
                         "other_kleb"="kleb_non_kpsc_or_kosc",
                         "ecoli"="escherichia") 
  
  script <- gsub("species_abbrev_name",species_abbrev_name,script)  %>% gsub("species_complex",species_complex,.)   %>% gsub("species",species,.) 
  writeLines(script,paste0("INTEGRATE_",species,"_kleborate.sbat"))
}
```
