---
title: "Results section 1: Propsective surveillance of CRKP from California LTACHs"
author: "Kyle Gontjes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
require(knitr)
opts_knit$set(echo = F,warning = FALSE, message = FALSE,error=F,comment=NA) 
opts_chunk$set(echo = F,warning = FALSE, message = FALSE,error=F,comment=NA)
opts_knit$set(root.dir='~/Desktop/gl_nfs/Project_INTEGRATE/Analysis/Resistance_dynamics/INTEGRATE-resistance-ms')
```


```{r} 
# Packages
packages <- c("tidyverse","gridExtra","kableExtra","tableone","gontjesr")
lapply(packages,library,character.only=T)

# Functions
source("./lib/consistent_themes.R")

# Print environment
Sys.info()
sessionInfo()
```

# Load data

```{r}
df <- readRDS("./data/dataset/CA_LTACH_first_clinical_CRKP_genomes_merged_studies_metadata.RDS")  

df_201415 <- df%>% subset(study == "2014-15")
df_202123 <- df%>% subset(study == "2021-23") 
```

# Overview of clinical specimens from 2021-23
```{r}
paste0("Number of specimens: ",nrow(df_202123))
paste0("Number of patients: ",length(unique(df_202123$participant_id)))

paste0("Minimum date: ",min(df_202123$date,na.rm=T))
paste0("Maximum date: ",max(df_202123$date,na.rm=T))

paste0("Number of facilities: ",length(unique(df_202123$hospital_location)))
```

# INTEGRATE metadata availability
```{r}
df_202123_no_metadata <- df %>% subset(is.na(hospital_location) & study =='2021-23')
df_202123_w_metadata <- df %>% subset(is.na(hospital_location)==F & study =='2021-23')
df_w_metadata <- df %>% subset(is.na(hospital_location)==F)

paste0("Number of isolates with metadata: ",nrow(df_202123_w_metadata))
paste0("Proportion of isolates with metadata: ",round(nrow(df_202123_w_metadata)/ sum(nrow(df_202123_no_metadata),nrow(df_202123_w_metadata)),3))
```

# Anatomical site
```{r} 
convert_tableone_into_df(dataset=df_202123_w_metadata,vars = "source_simplified") 
``` 

# Contextualization using old study
```{r}
paste0("Number of specimens: ",nrow(df_201415))
paste0("Number of patients: ",length(unique(df_201415$participant_id)))

paste0("Minimum date: ",min(df_201415$date,na.rm=T))
paste0("Maximum date: ",max(df_201415$date,na.rm=T))

paste0("Number of facilities: ",length(unique(df_201415$hospital_location %>% subset(.!='NA'),na.rm=T)))
``` 

# Source data 
```{r}
df$blood <- ifelse(df$source_simplified == "blood",1,0)
df$other<- ifelse(df$source_simplified == "other",1,0)
df$resp<- ifelse(df$source_simplified == "respiratory",1,0)
df$urine<- ifelse(df$source_simplified == "urine",1,0)
df$wound <- ifelse(df$source_simplified == "wound",1,0)

paste0("Overall")
source_table <- table(df_w_metadata$study,df_w_metadata$source_simplified) 
source_table  
source_table %>% fisher.test(simulate.p.value = T)

convert_tableone_into_df(dataset=df %>% subset(is.na(hospital_location) == F),vars = c("source_simplified","blood","other","resp","urine","wound"),strata='study',outcome_names = c("2021-23",'2014-15'),factorVars = c("source_simplified","blood","other","resp","urine","wound")) %>% favorite_kable()

paste0("No paramount")
no_paramount <- df %>% subset(is.na(hospital_location) == F & hospital_location != "Paramount")
source_table_no_par <- table(no_paramount$study,no_paramount$source_simplified) 
source_table_no_par  
source_table_no_par %>% fisher.test(simulate.p.value = T)

convert_tableone_into_df(dataset=df %>% subset(is.na(hospital_location) == F & hospital_location != "Paramount"),vars = c("source_simplified","blood","other","resp","urine","wound"),strata='study',outcome_names = c("2021-23",'2014-15'),factorVars = c("source_simplified","blood","other","resp","urine","wound")) %>% favorite_kable()
```

# Frequency differences
## Count
```{r}
paste0("Differences by study")
hospital_study_table <- table(df_w_metadata$study,df_w_metadata$hospital_location) 
hospital_study_table
hospital_study_table %>% fisher.test(simulate.p.value = T)

paste0("Differences by study w/o Paramount")
df_no_par <- subset(df_w_metadata,hospital_location != "Paramount")
hospital_study_table_no_par <- table(df_no_par$study,df_no_par$hospital_location) 
hospital_study_table_no_par
hospital_study_table_no_par %>% fisher.test(simulate.p.value = T)
```
 